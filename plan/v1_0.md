# v1.0 MCP (Minimal Complete Product)

## 🎯 总纲
- 跑通“上传 → 分发 → 训练 → 监控 → 归档”的最小闭环
- 管理端前端容器化、后端原生运行；计算端使用 Conda 源码环境
- 安全合规：用户 JWT、节点 PSK/Token、中间件强口令与 .env 管理
- 提供“计算节点池”基础页面与任务监控视图

## 二级大纲与三级大纲

### 1. 基础架构（Master-Worker）
#### 1.1 组件职责
- 管理端：FastAPI 后端、React 前端、Redis 队列、文件服务（如 MinIO），持久化至 workdir
- 计算端：Worker Agent + 训练进程，连接 Master，负责下载数据与回传产物
#### 1.2 网络与配置
- 环境变量：MASTER_URL、REDIS_URL、DB_PASSWORD、REDIS_PASSWORD、WORKDIR
- 心跳机制：Worker 每 30s 上报心跳，Master 超过 90s 未收到则标记离线
#### 1.3 目录与持久化
- workdir 结构：raw/processed/artifacts/logs；示例 D:\ProteinXWorkdir 或 /data/proteinx
- artifacts 归档格式：<job_id>/model.pth、metrics.json、train.log

### 2. 认证与安全
#### 2.1 用户认证（JWT）
- 接口：POST /api/auth/login，返回 access_token（15min）与 refresh_token（7d）
- 中间件：校验 Authorization: Bearer <token>，保护节点与任务接口
#### 2.2 节点认证（PSK/Token）
- Worker 启动参数：--token 或环境变量 WORKER_TOKEN
- 接口：POST /api/nodes/heartbeat 需附带 Token；非法 Token 拒绝并记录
#### 2.3 中间件强口令
- Redis、DB、MinIO 均通过强口令与最小权限账号接入
- .env 文件本地管理，不提交仓库；示例键：DB_PASSWORD、REDIS_PASSWORD、MASTER_URL

### 3. 数据流转
#### 3.1 上传与校验
- 支持格式：FASTA/CSV/TSV；大小限制默认 2GB；记录上传人与时间
- 存储路径：<workdir>/raw/<project>/<filename>；生成校验摘要（SHA256）
#### 3.2 分发与临时目录
- Worker 拉取：由任务载荷提供数据相对路径与签名；下载到本地 tmp 目录
- 清理策略：任务结束后清理 tmp；可配置保留最近 N 次

### 4. 训练任务（MVP）
#### 4.1 接口与状态机
- 创建任务：POST /api/jobs（字段：data_path、epochs、lr、notes）
- 日志读取：GET /api/jobs/{id}/logs（支持分页或流式）
- 产物回传：POST /api/jobs/{id}/artifacts（multipart/form-data）
- 状态：pending → running → succeeded/failed；记录开始/结束时间与错误信息
#### 4.2 调度与执行
- 调度：Master 将任务推送 Redis 队列（队列名 jobs.default）
- 执行：Worker 消费队列，运行 PyTorch 训练脚本（单 GPU/CPU）
#### 4.3 监控与可视
- 前端实时展示 loss/acc 简要折线与运行时长；失败显示错误摘要
- 任务详情页可下载 model.pth 与 metrics.json

### 5. 节点管理
#### 5.1 “计算节点池”页面
- 列字段：节点ID、IP/主机名、GPU/CPU、显存、在线状态（空闲/忙碌/离线）、最近心跳
- 操作：刷新、禁用/启用、查看节点日志
#### 5.2 节点 API
- 列表接口：GET /api/nodes 返回分页列表与资源概览
- 心跳接口：POST /api/nodes/heartbeat（载荷含 token、资源占用快照）

### 6. 监控与日志
#### 6.1 训练日志
- Worker 标准输出捕获并批量/流式回传；Master 统一落盘至 <workdir>/logs/<job_id>.log
#### 6.2 基础指标
- 展示 GPU 利用率/显存、CPU 与内存占用的近时快照；未来可接入 Prometheus

### 7. 部署与运维
#### 7.1 管理端
- 前端容器：proteinx/web:v1.0，映射 80:3000；由反向代理统一到 80/443
- 后端原生：uvicorn 启动 FastAPI；workdir 在系统设置页配置后生效
#### 7.2 计算端
- Conda 环境：environment.worker.yml 创建 proteinx-worker
- 启动示例：python -m worker.agent --master $MASTER_URL --redis $REDIS_URL
#### 7.3 版本与回滚
- 版本标签：TAG=v1.0.x；镜像与环境变量统一
- 回滚策略：改回上一 TAG，拉取并重启相关服务

### 8. 验收标准
#### 8.1 端到端闭环
- 成功上传 .fasta，创建任务，Worker 执行并回传日志与 model.pth
- artifacts 目录含模型与指标，前端任务详情可下载并查看
#### 8.2 安全与节点
- 登录方可访问任务与节点接口；非法 Token 心跳拒绝
- 节点池页面可见至少 1 个在线 Worker，状态随心跳变化

### 9. 范围外（v1.0 不包含）
#### 9.1 高级能力
- 复杂模型配置 UI、TensorBoard 深度可视、分布式 DDP、多租户权限体系

### 10. 里程碑
#### M1 架构与认证
- 完成 Master/Worker 启动与心跳、JWT 登录与保护中间件
#### M2 数据与训练
- 跑通上传/分发/训练脚本与 Redis 队列，日志与产物回传
#### M3 节点池与监控
- 节点池页面上线，任务监控基础图表与详情页下载
#### M4 发布与验收
- v1.0 发布与回滚脚本，端到端验收通过并记录报告

### 11. 跨平台与兼容性
#### 11.1 平台支持
- Windows 与 Linux 双平台兼容，路径与卷映射在 Compose 中分别适配
#### 11.2 依赖与环境
- 后端与计算端均提供 requirements / environment 文件，确保跨平台一致性
#### 11.3 文件系统
- workdir 位置通过 .env 配置，统一映射到后端容器 `/data`，避免平台差异
